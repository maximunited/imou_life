name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ACTIONS_STEP_DEBUG: false
      ACTIONS_RUNNER_DEBUG: false
    steps:
    - name: Check out the repository
      uses: actions/checkout@v4

    - name: Get integration name
      id: information
      shell: bash
      run: |
        name=$(find custom_components/ -type d -maxdepth 1 | tail -n 1 | cut -d "/" -f2)
        echo "name: $name"
        echo "name=$name" >> $GITHUB_OUTPUT

    - name: Update manifest version
      id: version
      run: |
        # Extract version from git tag (remove 'v' prefix)
        version=${GITHUB_REF#refs/tags/}
        version=${version#v}
        echo "Updating manifest.json version to $version"

        # Update version in manifest.json
        sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$version\"/" custom_components/imou_life/manifest.json

        # Display the updated manifest
        cat custom_components/imou_life/manifest.json
        echo "version=$version" >> $GITHUB_OUTPUT

    - name: Create zip file for the integration
      run: |
        cd "${{ github.workspace }}/custom_components/${{ steps.information.outputs.name }}"
        zip ${{ steps.information.outputs.name }}.zip -r ./
        mv ${{ steps.information.outputs.name }}.zip "${{ github.workspace }}/"
        ls -la "${{ github.workspace }}/"

    - name: Get Changelog Entry
      id: changelog_reader
      uses: mindsers/changelog-reader-action@v2
      with:
        validation_depth: 10
        version: ${{ steps.version.outputs.version }}
        path: ./CHANGELOG.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Imou Life ${{ github.ref_name }}
        body: |
          ## Imou Life ${{ github.ref_name }}

          ### Features
          - Home Assistant integration for Imou cameras and devices
          - Support for switches, sensors, binary sensors, and camera entities
          - Configuration via UI with device discovery
          - Real-time status updates and control

          ### Changes
          ${{ steps.changelog_reader.outputs.changes }}

          ### Installation
          1. Download the `${{ steps.information.outputs.name }}.zip` file from this release
          2. Extract to your Home Assistant `custom_components` directory
          3. Restart Home Assistant
          4. Add the integration via Settings > Devices & Services

          ### Requirements
          - Home Assistant 2023.8.0 or later
          - imouapi==1.0.15

        files: |
          ${{ github.workspace }}/${{ steps.information.outputs.name }}.zip
        draft: true
        prerelease: false
